from typing import List, Optional
from fastapi import APIRouter, Body, Depends, HTTPException, Path, Query, status
from pydantic import UUID4

from store.core.exceptions import BadRequestException, NotFoundException
from store.schemas.product import ProductIn, ProductOut, ProductUpdate, ProductUpdateOut
from store.usecases.product import ProductUsecase

router = APIRouter(tags=["products"])


@router.post(path="/", summary="Cria um produto", status_code=status.HTTP_201_CREATED)
async def post(
    body: ProductIn = Body(...), usecase: ProductUsecase = Depends()
) -> ProductOut:
    if not body:
        raise HTTPException(
            status_code=status.HTTP_422_UNPROCESSABLE_ENTITY,
        )
    return await usecase.create(body=body)


@router.get(
    path="/{id}", summary="Busca um produto por id", status_code=status.HTTP_200_OK
)
async def get(
    id: UUID4 = Path(alias="id"), usecase: ProductUsecase = Depends()
) -> ProductOut:
    try:
        return await usecase.get(id=id)
    except NotFoundException as exc:
        raise HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail=exc.message)


@router.get(path="/", summary="Lista todos os produtos", status_code=status.HTTP_200_OK)
async def query(
    usecase: ProductUsecase = Depends(),
    price_min: Optional[float] = Query(None),
    price_max: Optional[float] = Query(None),
) -> List[ProductOut]:
    filter = {}
    if price_min is not None and price_max is not None:
        filter = {"price": {"$gt": price_min, "$lt": price_max}}
    return await usecase.query(filter)


@router.patch(
    path="/{id}", summary="Atualiza um produto por id", status_code=status.HTTP_200_OK
)
async def patch(
    id: UUID4 = Path(alias="id"),
    body: ProductUpdate = Body(...),
    usecase: ProductUsecase = Depends(),
) -> ProductUpdateOut:
    try:
        return await usecase.update(id=id, body=body)
    except BadRequestException as exc:
        HTTPException(status_code=status.HTTP_400_BAD_REQUEST, detail=exc.message)


@router.delete(
    path="/{id}",
    summary="Deleta um produto por id",
    status_code=status.HTTP_204_NO_CONTENT,
)
async def delete(
    id: UUID4 = Path(alias="id"), usecase: ProductUsecase = Depends()
) -> None:
    try:
        await usecase.delete(id=id)
    except NotFoundException as exc:
        raise HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail=exc.message)
